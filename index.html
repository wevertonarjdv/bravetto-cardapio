<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Bravetto</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='32' fill='%23222222'/%3E%3Cpath d='M32 10c6 6-4 12-2 16 6 6 16-2 12-10 2 10-12 10-10 0 2-8-2-10-2-6z' fill='%23d4af37'/%3E%3Cpath d='M32 50c-12-6-20-18-18-36l8-3v7l-4 1c-1 13 7 22 14 26 7-4 15-13 14-26l-4-1v-7l8 3c2 18-6 30-18 36z' fill='%23f7d774'/%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ESTILOS OTIMIZADOS */
    :root{
      --bg:#0b0b0c;
      --panel:#111114;
      --panel-2:#141418;
      --gold:#d4af37;
      --gold-2:#f7d774;
      --text:#ececf1;
      --muted:#a1a1aa;
      --ok:#2ecc71;
      --danger:#ff5c5c;
      --radius:16px;
      --shadow:0 8px 24px rgba(0,0,0,.35);
      --accent:var(--gold);
      --brand-font:'Cinzel',serif;
      --ui-font:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
    }
    
    *{box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%; background:var(--bg); color:var(--text); font-size:15px; overflow-x: hidden;}
    body{
      margin:0; font-family:var(--ui-font); 
      background:
        radial-gradient(1400px 900px at 20% -10%, rgba(212,175,55,.10), transparent 55%),
        radial-gradient(1000px 700px at 120% 10%, rgba(247,215,116,.06), transparent 60%),
        var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      padding-bottom: env(safe-area-inset-bottom);
      position: relative;
      min-height: 100vh;
    }

    header{
      position:sticky; top:0; z-index:30; backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg, rgba(17,17,20,.92), rgba(17,17,20,.72));
      border-bottom:1px solid rgba(212,175,55,.20);
      padding:12px 0;
    }
    .wrap{width:100%; max-width:100%; padding:0 16px; margin:0 auto; overflow: hidden;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .brand{display:flex; align-items:center; gap:12px; flex:1; min-width:0;}
    .logo{
      width:50px;height:50px;border-radius:14px; overflow:hidden; flex:0 0 50px;
      background:#0f0f12 center/cover no-repeat; border:1px solid rgba(212,175,55,.35);
      box-shadow:inset 0 2px 4px rgba(255,255,255,.08),0 4px 12px rgba(0,0,0,.45);
    }
    .brand-text{min-width:0;}
    .brand h1{margin:0; font:900 22px/1 var(--brand-font); letter-spacing:.5px; color:var(--gold-2); text-shadow:0 2px 8px rgba(247,215,116,.25); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .brand small{display:block; margin-top:2px; color:var(--muted); font-size:11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .admin-btn{
      padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer; border:1px solid rgba(212,175,55,.45);
      color:#111; background:linear-gradient(180deg, var(--gold), var(--gold-2));
      box-shadow:0 4px 12px rgba(212,175,55,.25);
      font-size:13px;
      white-space: nowrap;
    }
    .status-pill{
      display:flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px;
      background:#0f0f12; border:1px solid rgba(212,175,55,.25); color:#d7d7dc; font-size:12px;
      margin-left: auto; flex-shrink: 0;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--ok);box-shadow:0 0 0 3px rgba(46,204,113,.18);}

    .instagram-section {
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      padding: 16px;
      border-radius: var(--radius);
      margin: 16px 0;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .instagram-title {
      color: white;
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .instagram-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: white;
      color: #000;
      padding: 10px 16px;
      border-radius: 30px;
      font-weight: 700;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .instagram-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .promo-banner {
      background: linear-gradient(120deg, rgba(212,175,55,.15), rgba(247,215,116,.08));
      border: 1px solid rgba(212,175,55,.35);
      border-radius: var(--radius);
      padding: 16px;
      margin: 16px 0;
      position: relative;
      overflow: hidden;
    }
    .promo-banner h3 {
      margin: 0 0 8px 0;
      color: var(--gold-2);
      font-family: var(--brand-font);
      font-size: 18px;
    }
    .promo-banner p {
      margin: 0;
      font-size: 14px;
      color: var(--text);
    }
    .promo-banner img {
      width: 100%;
      border-radius: 12px;
      margin-top: 12px;
      max-height: none;
      object-fit: contain;
    }
    .promo-banner .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
    }

    .location-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      width: fit-content;
    }

    .tools{display:flex; flex-direction:column; gap:12px; margin-top:12px;}
    .search{display:flex; gap:8px; position: relative;}
    .search input{
      flex:1; padding:14px 16px 14px 45px; border-radius:14px; background:#0f0f12; color:#fff; outline:none;
      border:1px solid rgba(212,175,55,.25); box-shadow:var(--shadow); font-size:15px;
      -webkit-appearance: none;
    }
    .search i {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
    }
    .chips{display:flex; gap:6px; flex-wrap:nowrap; align-items:center; overflow-x:auto; padding:4px 0; -webkit-overflow-scrolling: touch;}
    .chips::-webkit-scrollbar {display: none;}
    .chip{
      padding:8px 14px; border-radius:20px; background:#16161a; white-space: nowrap;
      border:1px solid rgba(212,175,55,.25); cursor:pointer; font-size:13px; user-select:none;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }
    .chip.active{
      background:linear-gradient(120deg, rgba(212,175,55,.35), rgba(247,215,116,.18)); 
      border-color:rgba(212,175,55,.65);
    }

    main{width:100%; max-width:100%; margin:16px auto 100px; padding:0 16px;}
    
    /* MELHORIA: Grid otimizado para 3 produtos por linha em dispositivos móveis */
    .grid{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      width: 100%;
    }
    
    .card{
      background:linear-gradient(180deg,var(--panel-2),var(--panel)); 
      border:1px solid rgba(212,175,55,.22); border-radius:var(--radius); 
      overflow:hidden; box-shadow:var(--shadow); position:relative;
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 28px rgba(0,0,0,0.4);
    }
    .card.disabled {
      opacity: 0.7;
      filter: grayscale(0.7);
    }
    .availability-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--danger);
      color: white;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      z-index: 2;
    }
    .thumb{
      aspect-ratio:1/1; 
      background:#0d0d10 center/cover no-repeat; 
      position: relative;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .thumb::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .card.disabled .thumb::after {
      opacity: 1;
    }
    .thumb .placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #1a1a1a, #2a2a2a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 14px;
      text-align: center;
    }
    .thumb .placeholder i {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }
    .info{
      padding: 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .title{
      font-weight:800; 
      font-size:14px; 
      font-family:var(--brand-font); 
      color:var(--gold-2); 
      line-height:1.2; 
      display: -webkit-box; 
      -webkit-line-clamp: 2; 
      -webkit-box-orient: vertical; 
      overflow: hidden; 
      min-height: 33.6px;
      margin-bottom: 4px;
    }
    .card.disabled .title {
      color: var(--muted);
    }
    .desc{
      font-size:12px; 
      color:var(--muted); 
      line-height:1.3; 
      display: -webkit-box; 
      -webkit-line-clamp: 2; 
      -webkit-box-orient: vertical; 
      overflow: hidden;
      flex: 1;
    }
    .full-desc {
      display: none;
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.4;
    }
    .show-details {
      color: var(--gold);
      font-size: 12px;
      margin-top: 6px;
      cursor: pointer;
      display: inline-block;
    }
    .row{
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:8px; 
      margin-top:10px;
    }
    .price{
      font-weight:900; 
      color:var(--gold-2); 
      font-size:15px;
    }
    .card.disabled .price {
      color: var(--muted);
      text-decoration: line-through;
    }
    .btn{
      padding:8px 12px; 
      border-radius:10px; 
      border:1px solid rgba(212,175,55,.35);
      background:linear-gradient(180deg, rgba(212,175,55,.18), rgba(212,175,55,.06)); 
      color:#fff; 
      cursor:pointer; 
      font-size:13px; 
      font-weight: 600;
      transition: all 0.3s ease;
      white-space: nowrap;
      z-index: 5;
      position: relative;
    }
    .btn:active{transform:translateY(1px);}
    .btn-primary{
      background:linear-gradient(180deg, rgba(212,175,55,.55), rgba(212,175,55,.28)); 
      color:#1a1a1c; 
      font-weight:900;
    }
    .btn:disabled {
      background: #1a1a1c;
      color: var(--muted);
      border-color: #2a2a2c;
      cursor: not-allowed;
    }

    .cart{position:fixed; right:16px; bottom:16px; z-index:40; display:flex; align-items:center; gap:8px;}
    .cart-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(180deg, var(--gold), var(--gold-2));
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: none;
      cursor: pointer;
    }
    .badge{
      position:absolute; top:-6px; right:-6px; background:var(--ok); color:#0b0b0c; 
      font-weight:900; border-radius:999px; padding:2px 6px; font-size:11px; border:2px solid #0b0b0c;
      min-width: 18px;
      text-align: center;
    }
    .sheet{
      position:fixed; inset:0; display:none; align-items:flex-end; 
      background:rgba(0,0,0,.6); z-index:50;
    }
    .sheet.open{display:flex;}
    .panel{
      background:#0f0f12; border-top-left-radius:20px; border-top-right-radius:20px; 
      width:100%; max-height:85vh; overflow:auto; border-top:1px solid rgba(212,175,55,.25);
    }
    .panel .header{
      display:flex; align-items:center; justify-content:space-between; 
      padding:16px; border-bottom:1px solid rgba(255,255,255,.06);
      position: sticky;
      top: 0;
      background: #0f0f12;
      z-index: 10;
    }
    .panel .body{padding:16px;}
    .cart-line{
      display:grid; grid-template-columns: 1fr auto auto; gap:10px; align-items:center; 
      padding:12px 0; border-bottom:1px dashed rgba(255,255,255,.08);
    }
    .total{
      display:flex; align-items:center; justify-content:space-between; 
      font-weight:900; padding:16px 0 8px; font-size: 17px;
    }

    .product-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      z-index: 100;
      overflow-y: auto;
      display: none;
    }
    .product-modal.open {
      display: block;
    }
    .product-header {
      position: relative;
      height: 250px;
    }
    .product-header img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .product-back {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.5);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
    }
    .product-body {
      padding: 20px;
      background: var(--panel);
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      margin-top: -20px;
      position: relative;
    }
    .product-title {
      font-size: 22px;
      font-weight: 900;
      color: var(--gold-2);
      margin-bottom: 8px;
      font-family: var(--brand-font);
    }
    .product-desc {
      color: var(--muted);
      margin-bottom: 16px;
      line-height: 1.5;
    }
    .product-price {
      font-size: 24px;
      font-weight: 900;
      color: var(--gold-2);
      margin-bottom: 20px;
    }
    .product-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .qty-selector {
      display: flex;
      align-items: center;
      background: var(--panel-2);
      border-radius: 10px;
      overflow: hidden;
    }
    .qty-btn {
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .qty-value {
      width: 40px;
      text-align: center;
      font-weight: 700;
    }
    .add-to-cart-btn {
      flex: 1;
      background: linear-gradient(180deg, var(--gold), var(--gold-2));
      border: none;
      border-radius: 10px;
      color: #000;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
    }

    .ratings-section {
      margin-top: 30px;
      text-align: center;
      padding: 20px;
      background: var(--panel-2);
      border-radius: var(--radius);
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--gold-2);
    }
    .rating-cta {
      margin-bottom: 16px;
      color: var(--muted);
    }
    .rating-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      color: white;
      padding: 12px 20px;
      border-radius: 30px;
      font-weight: 700;
      text-decoration: none;
      margin-top: 10px;
    }

    .modal-back{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; 
      background:rgba(0,0,0,.72); z-index:80; padding:16px;
    }
    .modal{
      width:100%; max-height:90vh; overflow:auto; background:#111116; 
      border:1px solid rgba(212,175,55,.28); border-radius:20px; box-shadow:var(--shadow); padding:16px;
    }
    .modal h3{margin:0 0 10px; font:900 20px/1 var(--brand-font); color:var(--gold-2);}
    .sub{color:var(--muted); font-size:13px; margin:-6px 0 12px;}
    .grid-2{display:grid; grid-template-columns:1fr; gap:12px;}
    .field{display:flex; flex-direction:column; gap:6px;}
    .field label{font-size:13px; color:var(--muted);}
    .field input,.field select,.field textarea{
      width:100%; padding:12px 14px; border-radius:12px; background:#0f0f12; 
      color:#fff; border:1px solid rgba(212,175,55,.25); outline:none; font-size:15px;
    }
    .hr{height:1px; background:rgba(255,255,255,.08); margin:14px 0; border-radius:1px;}
    .empty{color:var(--muted); padding:12px; text-align: center;}

    .help{font-size:12px; color:var(--muted);}
    .muted{color:var(--muted);}

    .address-form {
      margin-top: 16px;
      padding: 16px;
      background: var(--panel);
      border-radius: var(--radius);
      border: 1px solid rgba(212,175,55,.22);
    }
    .address-form h3 {
      margin: 0 0 12px 0;
      font: 700 16px/1 var(--ui-font);
      color: var(--gold-2);
    }
    .address-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      cursor: pointer;
    }
    .address-toggle span {
      font-size: 14px;
    }
    .address-fields {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .address-saved {
      background: rgba(46, 204, 113, 0.1);
      border: 1px solid rgba(46, 204, 113, 0.3);
      border-radius: 10px;
      padding: 12px;
      margin-top: 12px;
      display: none;
    }
    .address-saved p {
      margin: 0;
      font-size: 14px;
    }
    .address-saved .edit-address {
      color: var(--gold);
      text-decoration: underline;
      cursor: pointer;
      font-size: 13px;
      margin-top: 8px;
      display: inline-block;
    }

    .general-message {
      background: rgba(212,175,55,.10);
      border: 1px solid rgba(212,175,55,.25);
      border-radius: var(--radius);
      padding: 12px 16px;
      margin: 16px 0;
      text-align: center;
      font-size: 14px;
    }

    .store-closed-message {
      background: rgba(255, 92, 92, 0.10);
      border: 1px solid rgba(255, 92, 92, 0.25);
      border-radius: var(--radius);
      padding: 12px 16px;
      margin: 16px 0;
      text-align: center;
      font-size: 14px;
      color: #ff7a7a;
    }

    .free-delivery-message {
      background: rgba(46, 204, 113, 0.10);
      border: 1px solid rgba(46, 204, 113, 0.25);
      border-radius: var(--radius);
      padding: 12px 16px;
      margin: 16px 0;
      text-align: center;
      font-size: 14px;
      color: var(--ok);
    }

    .developer-credits {
      text-align: center;
      padding: 20px 0;
      margin-top: 40px;
      border-top: 1px solid rgba(212,175,55,.2);
      background: rgba(11,11,12,0.8);
    }
    .developer-credits p {
      margin: 0;
      font-size: 14px;
      color: var(--muted);
    }
    .developer-name {
      font-weight: 700;
      color: var(--gold) !important;
      font-size: 15px !important;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 5px;
      display: block;
      text-shadow: 0 0 10px rgba(212,175,55,0.3);
    }

    .admin-section {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--panel);
      border-radius: var(--radius);
      border: 1px solid rgba(212,175,55,.22);
    }
    .admin-section h3 {
      margin: 0 0 16px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(212,175,55,.3);
    }
    .admin-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    /* NOVOS ESTILOS PARA SORTEIO */
    .sorteio-section {
      background: linear-gradient(135deg, rgba(212,175,55,.15), rgba(247,215,116,.08));
      border: 1px solid rgba(212,175,55,.35);
      border-radius: var(--radius);
      padding: 20px;
      margin: 16px 0;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .sorteio-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--gold), var(--gold-2));
    }
    .sorteio-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, var(--gold), var(--gold-2));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: #0b0b0c;
      box-shadow: 0 4px 12px rgba(212,175,55,.3);
    }
    .sorteio-title {
      font-size: 24px;
      font-weight: 900;
      color: var(--gold-2);
      margin-bottom: 8px;
      font-family: var(--brand-font);
      text-shadow: 0 2px 8px rgba(247,215,116,.25);
    }
    .sorteio-subtitle {
      color: var(--muted);
      margin-bottom: 20px;
      font-size: 14px;
    }
    .sorteio-form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      max-width: 400px;
      margin: 0 auto;
    }
    .sorteio-form .field {
      text-align: left;
    }
    .sorteio-btn {
      background: linear-gradient(180deg, var(--gold), var(--gold-2));
      color: #0b0b0c;
      border: none;
      border-radius: 10px;
      padding: 14px 20px;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    .sorteio-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(212,175,55,.4);
    }
    .sorteio-btn:disabled {
      background: #2a2a2c;
      color: var(--muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .sorteio-success {
      background: rgba(46, 204, 113, 0.1);
      border: 1px solid rgba(46, 204, 113, 0.3);
      border-radius: 10px;
      padding: 16px;
      margin-top: 16px;
      display: none;
    }
    .sorteio-success p {
      margin: 0;
      font-size: 14px;
      color: var(--ok);
    }
    .sorteio-participants {
      margin-top: 20px;
      font-size: 14px;
      color: var(--muted);
    }
    .sorteio-participants strong {
      color: var(--gold-2);
    }

    .sorteio-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 20px;
    }
    .sorteio-modal.open {
      display: flex;
    }
    .sorteio-modal-content {
      background: var(--panel);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      text-align: center;
      border: 1px solid rgba(212,175,55,.3);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .sorteio-modal-title {
      font-size: 28px;
      font-weight: 900;
      color: var(--gold-2);
      margin-bottom: 16px;
      font-family: var(--brand-font);
    }
    .roleta-container {
      width: 300px;
      height: 300px;
      margin: 20px auto;
      position: relative;
    }
    .roleta {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(
        from 0deg,
        #d4af37 0deg 90deg,
        #f7d774 90deg 180deg,
        #d4af37 180deg 270deg,
        #f7d774 270deg 360deg
      );
      position: relative;
      transition: transform 4s cubic-bezier(0.2, 0.8, 0.2, 1);
      transform: rotate(0deg);
      box-shadow: 0 0 20px rgba(212,175,55,.5);
    }
    .roleta-ponteiro {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 30px solid var(--gold-2);
      z-index: 10;
    }
    .roleta-vencedor {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      background: var(--panel);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      color: var(--gold-2);
      font-size: 18px;
      border: 4px solid var(--gold);
      box-shadow: 0 0 0 8px rgba(212,175,55,.2);
    }
    .sorteio-resultado {
      margin-top: 20px;
      padding: 20px;
      background: rgba(46, 204, 113, 0.1);
      border-radius: 10px;
      border: 1px solid rgba(46, 204, 113, 0.3);
      display: none;
    }
    .sorteio-resultado h3 {
      color: var(--ok);
      margin-bottom: 10px;
    }
    .sorteio-resultado p {
      margin: 5px 0;
      font-size: 16px;
    }
    .sorteio-resultado .whatsapp-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #25D366;
      color: white;
      padding: 10px 16px;
      border-radius: 30px;
      font-weight: 700;
      text-decoration: none;
      margin-top: 10px;
      transition: all 0.3s ease;
    }
    .sorteio-resultado .whatsapp-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37,211,102,0.3);
    }

    /* MELHORIAS RESPONSIVAS */
    @media (max-width: 360px) {
      .brand h1 { font-size: 18px; }
      .brand small { font-size: 10px; }
      .admin-btn { padding: 7px 10px; font-size: 12px; }
      .status-pill { font-size: 11px; padding: 5px 8px; }
      .grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .card .btn { padding: 6px 10px; font-size: 12px; }
      .title { min-height: 30px; font-size: 13px; }
      .roleta-container { width: 250px; height: 250px; }
      .roleta-vencedor { width: 80px; height: 80px; font-size: 16px; }
    }

    @media (max-width: 480px) {
      .topbar { flex-wrap: wrap; }
      .status-pill { order: 3; width: 100%; justify-content: center; margin-top: 8px; margin-left: 0; }
      .sorteio-modal-content { padding: 20px; }
    }

    @media (min-width: 768px) {
      .wrap { max-width: 720px; }
      .grid { grid-template-columns: repeat(4, 1fr); gap: 16px; }
      .grid-2 { grid-template-columns: 1fr 1fr; }
      .address-fields { grid-template-columns: 1fr 1fr; }
      .address-fields .field:last-child { grid-column: 1 / span 2; }
      .product-modal {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .product-modal .product-content {
        width: 600px;
        height: auto;
        border-radius: 20px;
        overflow: hidden;
      }
      .product-header {
        height: 300px;
      }
      .sorteio-form {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (min-width: 992px) {
      .wrap { max-width: 960px; }
      .grid { grid-template-columns: repeat(5, 1fr); }
    }

    @media (min-width: 1200px) {
      .wrap { max-width: 1140px; }
      .grid { grid-template-columns: repeat(6, 1fr); }
    }

    @supports(padding: max(0px)) {
      body, header {
        padding-left: max(16px, env(safe-area-inset-left));
        padding-right: max(16px, env(safe-area-inset-right));
      }
      .cart {
        right: max(16px, env(safe-area-inset-right));
        bottom: max(16px, env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div id="brandLogo" class="logo" style="background-image:url('https://raw.githubusercontent.com/finetuner-oss/storage/main/brand/bravetto-gold.png');"></div>
          <div class="brand-text">
            <h1 id="brandName">Bravetto</h1>
            <small id="brandTag">Pizzas • Hambúrgueres • Delivery</small>
          </div>
        </div>

        <div class="status-pill" title="Status da loja">
          <div class="dot" id="statusDot"></div>
          <div><b id="statusText">Aberto agora</b> <span id="hours" class="muted"></span></div>
        </div>
        
        <button id="adminBtn" class="admin-btn" title="Painel administrativo">Admin</button>
      </div>

      <!-- Localização simplificada -->
      <div class="location-selector">
        <i class="fas fa-map-marker-alt"></i>
        <span>Entregar em: Minha Casa</span>
        <i class="fas fa-chevron-down"></i>
      </div>

      <div class="tools">
        <div class="search">
          <i class="fas fa-search"></i>
          <input id="q" type="search" placeholder="Buscar no cardápio..." oninput="render()"/>
        </div>
        <div id="chips" class="chips"></div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <!-- Seção Instagram -->
    <div class="instagram-section">
      <h3 class="instagram-title">Siga-nos no Instagram</h3>
      <p>Poste sua experiência marcando @_bravetto_ e apareça em nossa página!</p>
      <a href="https://www.instagram.com/_bravetto_?igsh=cGF5MDhsbXR5YjZq&utm_source=qr" class="instagram-btn">
        <i class="fab fa-instagram"></i> Seguir @_bravetto_
      </a>
    </div>
    
    <!-- Mensagem Geral -->
    <div id="generalMessage" class="general-message" style="display: none;"></div>
    
    <!-- Aviso de loja fechada -->
    <div id="storeClosedMessage" class="store-closed-message" style="display: none;">
      <b>Loja Fechada</b> - No momento não estamos aceitando pedidos. Volte em breve!
    </div>
    
    <!-- Mensagem de entrega grátis -->
    <div id="freeDeliveryMessage" class="free-delivery-message">
      <i class="fas fa-truck"></i> <b>Entrega grátis</b> em pedidos acima de R$ 60,00
    </div>
    
    <!-- Banner de Promoção -->
    <div id="promoBanner" class="promo-banner" style="display: none;">
      <button class="close-btn" onclick="closePromoBanner()">×</button>
      <h3 id="promoTitle"></h3>
      <p id="promoDescription"></p>
      <img id="promoImage" src="" alt="Promoção do dia">
    </div>
    
    <!-- NOVA SEÇÃO: Sorteio Bravetto -->
    <div id="sorteioSection" class="sorteio-section" style="display: none;">
      <div class="sorteio-logo">
        <i class="fas fa-gift"></i>
      </div>
      <h2 class="sorteio-title">Sorteio Bravetto</h2>
      <p class="sorteio-subtitle">Participe do nosso sorteio e concorra a prêmios incríveis!</p>
      
      <div id="sorteioForm" class="sorteio-form">
        <div class="field">
          <label>Seu nome completo</label>
          <input type="text" id="sorteioNome" placeholder="Digite seu nome" required>
        </div>
        <div class="field">
          <label>Seu WhatsApp</label>
          <input type="tel" id="sorteioWhatsApp" placeholder="(XX) XXXXX-XXXX" required>
        </div>
        <button id="participarSorteio" class="sorteio-btn">Participar do Sorteio</button>
      </div>
      
      <div id="sorteioSuccess" class="sorteio-success">
        <p><i class="fas fa-check-circle"></i> <b>Inscrição confirmada!</b> Boa sorte no sorteio.</p>
      </div>
      
      <div class="sorteio-participants">
        <i class="fas fa-users"></i> <strong id="participantesCount">0</strong> pessoas já participaram
      </div>
    </div>
    
    <div style="margin:10px 0 8px" class="muted">Toque em um item para ver detalhes e adicionar ao pedido</div>
    <div id="grid" class="grid"></div>
  </main>

  <!-- Floating cart -->
  <div class="cart">
    <button class="cart-btn" onclick="openCart()">
      <i class="fas fa-shopping-bag"></i>
    </button>
    <span id="cartCount" class="badge">0</span>
  </div>

  <!-- Cart sheet -->
  <div id="sheet" class="sheet">
    <div class="panel">
      <div class="header">
        <strong>Seu pedido</strong>
        <button class="btn" onclick="closeCart()">Fechar</button>
      </div>
      <div id="cartBody" class="body"></div>
    </div>
  </div>

  <!-- Modal de produto -->
  <div id="productModal" class="product-modal">
    <div class="product-content">
      <div class="product-header">
        <img id="modalProductImage" src="" alt="">
        <div class="product-back" onclick="closeProductModal()">
          <i class="fas fa-arrow-left"></i>
        </div>
      </div>
      <div class="product-body">
        <h2 id="modalProductName" class="product-title"></h2>
        <p id="modalProductDesc" class="product-desc"></p>
        <div id="modalProductPrice" class="product-price"></div>
        
        <div class="product-actions">
          <div class="qty-selector">
            <button class="qty-btn" onclick="changeModalQty(-1)">-</button>
            <div class="qty-value" id="modalQty">1</div>
            <button class="qty-btn" onclick="changeModalQty(1)">+</button>
          </div>
          <button class="add-to-cart-btn" onclick="addFromModal()">
            Adicionar • <span id="modalTotalPrice"></span>
          </button>
        </div>
        
        <!-- Seção de avaliações simplificada -->
        <div class="ratings-section">
          <h3 class="section-title">Avalie nosso produto</h3>
          <p class="rating-cta">Poste uma foto no Instagram marcando @_bravetto_</p>
          <a href="https://www.instagram.com/_bravetto_?igsh=cGF5MDhsbXR5YjZq&utm_source=qr" class="rating-button">
            <i class="fab fa-instagram"></i> Avaliar no Instagram
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- NOVO MODAL: Sorteio - Roleta -->
  <div id="sorteioModal" class="sorteio-modal">
    <div class="sorteio-modal-content">
      <h2 class="sorteio-modal-title">Sortear Vencedor</h2>
      <p>Clique no botão abaixo para sortear um vencedor entre os participantes.</p>
      
      <div class="roleta-container">
        <div class="roleta-ponteiro"></div>
        <div id="roleta" class="roleta">
          <div class="roleta-vencedor">?</div>
        </div>
      </div>
      
      <button id="sortearBtn" class="sorteio-btn" style="margin-top: 20px;">
        <i class="fas fa-random"></i> Sortear Vencedor
      </button>
      
      <div id="sorteioResultado" class="sorteio-resultado">
        <h3><i class="fas fa-trophy"></i> Parabéns ao vencedor!</h3>
        <p><strong>Nome:</strong> <span id="vencedorNome"></span></p>
        <p><strong>WhatsApp:</strong> <span id="vencedorWhatsApp"></span></p>
        <a id="vencedorWhatsAppLink" class="whatsapp-btn" target="_blank">
          <i class="fab fa-whatsapp"></i> Entrar em contato
        </a>
        <button class="btn" onclick="fecharSorteio()" style="margin-top: 10px; width: 100%;">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Admin: login -->
  <div id="loginBack" class="modal-back">
    <div class="modal" style="max-width:420px">
      <h3>Acesso Administrativo</h3>
      <div class="sub">Digite a senha para abrir o painel.</div>
      <div class="field">
        <label>Senha</label>
        <input id="adminPass" type="password" placeholder="••••••••"/>
      </div>
      <div id="loginError" class="help" style="color:var(--danger); display:none">Senha incorreta</div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px">
        <button class="btn" onclick="hideLogin()">Cancelar</button>
        <button class="btn btn-primary" onclick="checkLogin()">Acessar</button>
      </div>
    </div>
  </div>

  <!-- Admin: panel -->
  <div id="adminBack" class="modal-back">
    <div class="modal">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap: wrap;">
        <h3>Painel Administrativo</h3>
        <div class="admin-actions">
          <button class="btn" onclick="exportBackup()">Exportar</button>
          <label class="btn">
            Importar <input id="importFile" type="file" accept="application/json" style="display:none">
          </label>
          <button class="btn" onclick="resetAll()">Resetar</button>
          <button class="btn" onclick="closeAdmin()">Fechar</button>
          <button class="btn btn-primary" onclick="saveAll()">Salvar Tudo</button>
        </div>
      </div>
      <div class="sub">Tudo é salvo automaticamente no Firebase e sincronizado entre dispositivos.</div>

      <!-- Loja -->
      <div class="admin-section">
        <h3>Configurações da Loja</h3>
        <div class="grid-2">
          <div class="field">
            <label>Nome da Loja</label>
            <input id="st_name" type="text">
          </div>
          <div class="field">
            <label>Slogan</label>
            <input id="st_tag" type="text">
          </div>
          <div class="field">
            <label>Logo (URL)</label>
            <input id="st_logo" type="url" placeholder="https://...png, jpg">
          </div>
          <div class="field">
            <label>WhatsApp (somente números, com DDI+DDD)</label>
            <input id="st_wa" type="tel" placeholder="5534991301417">
          </div>
          <div class="field">
            <label>Taxa de entrega (R$)</label>
            <input id="st_frete" type="number" min="0" step="0.01">
          </div>
          <div class="field">
            <label>Frete grátis a partir de (R$)</label>
            <input id="st_free" type="number" min="0" step="0.01" value="60">
          </div>
          <div class="field">
            <label>Status</label>
            <select id="st_open">
              <option value="open">Aberto</option>
              <option value="closed">Fechado</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Mensagem Geral -->
      <div class="admin-section">
        <h3>Mensagem Geral</h3>
        <div class="field">
          <label>Mensagem para todos os clientes</label>
          <textarea id="st_message" placeholder="Digite uma mensagem que aparecerá para todos os clientes"></textarea>
        </div>
      </div>

      <!-- Promoção do Dia -->
      <div class="admin-section">
        <h3>Promoção do Dia</h3>
        <div class="grid-2">
          <div class="field">
            <label>Título da Promoção</label>
            <input id="st_promo_title" type="text" placeholder="Título chamativo">
          </div>
          <div class="field">
            <label>Descrição</label>
            <textarea id="st_promo_desc" placeholder="Descreva a promoção"></textarea>
          </div>
          <div class="field">
            <label>Imagem (URL)</label>
            <input id="st_promo_img" type="url" placeholder="https://...imagem.jpg">
          </div>
          <div class="field">
            <label>Status da Promoção</label>
            <select id="st_promo_active">
              <option value="false">Desativada</option>
              <option value="true">Ativada</option>
            </select>
          </div>
        </div>
      </div>

      <!-- NOVA SEÇÃO: Sorteio -->
      <div class="admin-section">
        <h3>Configurações do Sorteio</h3>
        <div class="grid-2">
          <div class="field">
            <label>Status do Sorteio</label>
            <select id="st_sorteio_active">
              <option value="false">Desativado</option>
              <option value="true">Ativado</option>
            </select>
          </div>
          <div class="field">
            <label>Título do Sorteio</label>
            <input id="st_sorteio_titulo" type="text" placeholder="Ex: Sorteio Pizza Grátis">
          </div>
          <div class="field">
            <label>Descrição do Sorteio</label>
            <textarea id="st_sorteio_desc" placeholder="Descreva o prêmio e as regras"></textarea>
          </div>
          <div class="field">
            <label>Data do Sorteio</label>
            <input id="st_sorteio_data" type="date">
          </div>
        </div>
        <div class="admin-actions">
          <button class="btn" onclick="abrirSorteioModal()">
            <i class="fas fa-random"></i> Realizar Sorteio
          </button>
          <button class="btn" onclick="exportarParticipantes()">
            <i class="fas fa-download"></i> Exportar Participantes
          </button>
          <button class="btn" style="border-color:rgba(255,92,92,.5)" onclick="limparParticipantes()">
            <i class="fas fa-trash"></i> Limpar Participantes
          </button>
        </div>
        <div class="sorteio-participants" style="margin-top: 16px;">
          <i class="fas fa-users"></i> <strong id="adminParticipantesCount">0</strong> participantes inscritos
        </div>
      </div>

      <!-- Categorias -->
      <div class="admin-section">
        <h3>Categorias</h3>
        <div class="help">Adicione, edite ou remova categorias. Para remover, deixe o campo em branco.</div>
        <div id="categoriesList"></div>
        <button class="btn" onclick="addCategoryField()" style="margin-top: 12px;">+ Adicionar Categoria</button>
      </div>

      <!-- Produtos -->
      <div class="admin-section">
        <h3>Produtos</h3>
        <div class="help">Edite os campos abaixo. As alterações serão salvas automaticamente.</div>
        <div id="prodList"></div>
        <div style="display:flex; gap:10px; margin-top:12px">
          <button class="btn" onclick="addProduct()">+ Adicionar produto</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Créditos do desenvolvedor -->
  <footer class="developer-credits">
    <div class="wrap">
      <p>Desenvolvido por</p>
      <span class="developer-name">Weverton Araujo</span>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
  // CORREÇÃO DOS PROBLEMAS:
  // 1. Botão "Adicionar" não aparecendo no mobile
  // 2. Clique indo direto para a imagem ao invés de abrir o modal

  // Configurações iniciais
  const ADMIN_PASSWORD = '1a2b3c4D@7';
  const LS_KEY = 'bravetto_menu_v1';
  const LS_ADDRESS_KEY = 'bravetto_address';
  const LS_PROMO_CLOSED = 'bravetto_promo_closed';

  // Configuração do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCimABHZZvGT-W4b_ouEieF0XiizLo6DVw",
    authDomain: "cardapiobravetto.firebaseapp.com",
    databaseURL: "https://cardapiobravetto-default-rtdb.firebaseio.com",
    projectId: "cardapiobravetto",
    storageBucket: "cardapiobravetto.firebasestorage.app",
    messagingSenderId: "303652377735",
    appId: "1:303652377735:web:f0af28ded5d3b731881422",
    measurementId: "G-PNTPM6DESN"
  };

  // IMAGENS DE FALLBACK - URLs confiáveis
  const FALLBACK_IMAGES = {
    'pizza': 'https://images.unsplash.com/photo-1513104890138-7c749659a591?q=80&w=500&auto=format&fit=crop',
    'hamburguer': 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?q=80&w=500&auto=format&fit=crop',
    'bebida': 'https://images.unsplash.com/photo-1622484212603-c5aa0dbf9296?q=80&w=500&auto=format&fit=crop',
    'combo': 'https://images.unsplash.com/photo-1561758033-d89a9ad46330?q=80&w=500&auto=format&fit=crop',
    'default': 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=500&auto=format&fit=crop'
  };

  const DEFAULT_SETTINGS = {
    name:'Bravetto',
    tag:'Pizzas • Hambúrgueres • Delivery',
    logo:'https://raw.githubusercontent.com/finetuner-oss/storage/main/brand/bravetto-gold.png',
    whatsapp:'5534991301417',
    frete:5,
    frete_free:60,
    open:'open',
    message: '',
    promo: {
      title: '',
      description: '',
      image: '',
      active: false
    },
    sorteio: {
      active: false,
      titulo: 'Sorteio Bravetto',
      descricao: 'Participe do nosso sorteio e concorra a prêmios incríveis!',
      data: '',
      participantes: []
    },
    categories: ['Pizzas', 'Hambúrgueres', 'Bebidas', 'Combos', 'Sobremesas']
  };

  const DEFAULT_PRODUCTS = [
    {id:'pz-marg', name:'Pizza Margherita', desc:'Molho de tomate, muçarela, manjericão fresco.', price:39.90, cat:'Pizzas', img:'https://images.unsplash.com/photo-1542281286-9e0a16bb7366?q=80&w=500&auto=format&fit=crop', available:true},
    {id:'pz-calab', name:'Pizza Calabresa', desc:'Calabresa fatiada, cebola, azeitona.', price:44.90, cat:'Pizzas', img:'https://images.unsplash.com/photo-1628840042765-356cda07504e?q=80&w=500&auto=format&fit=crop', available:true},
    {id:'pz-frango', name:'Pizza Frango c/ Catupiry', desc:'Frango desfiado, catupiry, milho, orégano.', price:49.90, cat:'Pizzas', img:'https://images.unsplash.com/photo-1541746972996-4e0b0f43e02a?q=80&w=500&auto=format&fit=crop', available:true},
    {id:'hb-smash', name:'Hambúrguer Smash', desc:'Carne smash 120g, queijo, picles e molho da casa.', price:27.90, cat:'Hambúrgueres', img:'https://images.unsplash.com/photo-1550547660-d9450f859349?q=80&w=500&auto=format&fit=crop', available:true},
    {id:'hb-bacon', name:'Cheese Bacon', desc:'Pão brioche, blend 160g, queijo duplo, bacon crocante.', price:31.90, cat:'Hambúrgueres', img:'https://images.unsplash.com/photo-1553979459-d2229ba7433b?q=80&w=500&auto=format&fit=crop', available:true},
    {id:'bd-lata', name:'Refrigerante Lata', desc:'Coca-Cola, Guaraná, Fanta... (350ml).', price:7.90, cat:'Bebidas', img:'https://images.unsplash.com/photo-1622484212603-c5aa0dbf9296?q=80&w=500&auto=format&fit=crop', available:true},
    {id:'cb-duo', name:'Combo Duo', desc:'1 Pizza média + 2 latas de refri.', price:69.90, cat:'Combos', img:'https://images.unsplash.com/photo-1561758033-d89a9ad46330?q=80&w=500&auto=format&fit=crop', available:true}
  ];

  let state = { 
    settings: {...DEFAULT_SETTINGS}, 
    products:[...DEFAULT_PRODUCTS],
  };
  let carrinho = [];
  let filtroCat = 'Todos';
  let isAdmin = false;
  let enderecoSalvo = null;
  let mostrarFormEndereco = false;
  let firebaseApp;
  let database;
  let currentProduct = null;
  let modalQty = 1;

  // Utilitários
  function $(sel) { return document.querySelector(sel); }
  function $$(sel) { return document.querySelectorAll(sel); }
  function money(v) { return (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
  function uid() { return 'id' + Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-3); }

  // SISTEMA DE CARREGAMENTO DE IMAGENS CORRIGIDO
  function loadProductImage(thumbDiv, produto) {
    // Primeiro mostrar placeholder
    thumbDiv.innerHTML = `
      <div class="placeholder">
        <i class="fas fa-${getCategoryIcon(produto.cat)}"></i>
        <div>Carregando...</div>
      </div>
    `;
    
    // Tentar carregar a imagem original
    const img = new Image();
    
    img.onload = function() {
      // Sucesso - usar imagem original
      thumbDiv.style.backgroundImage = `url('${produto.img}')`;
      thumbDiv.innerHTML = ''; // Remove o placeholder
    };
    
    img.onerror = function() {
      // Falha - usar fallback
      thumbDiv.style.backgroundImage = `url('${getFallbackImage(produto.cat)}')`;
      thumbDiv.innerHTML = ''; // Remove o placeholder
    };
    
    // Iniciar o carregamento
    img.src = produto.img;
  }

  function getCategoryIcon(categoria) {
    const cat = categoria.toLowerCase();
    if (cat.includes('pizza')) return 'pizza-slice';
    if (cat.includes('hambúrguer') || cat.includes('burger')) return 'hamburger';
    if (cat.includes('bebida') || cat.includes('refri') || cat.includes('drink')) return 'wine-bottle';
    if (cat.includes('combo')) return 'concierge-bell';
    return 'utensils';
  }

  function getFallbackImage(categoria) {
    const cat = categoria.toLowerCase();
    if (cat.includes('pizza')) return FALLBACK_IMAGES.pizza;
    if (cat.includes('hambúrguer') || cat.includes('burger')) return FALLBACK_IMAGES.hamburguer;
    if (cat.includes('bebida') || cat.includes('refri') || cat.includes('drink')) return FALLBACK_IMAGES.bebida;
    if (cat.includes('combo')) return FALLBACK_IMAGES.combo;
    return FALLBACK_IMAGES.default;
  }

  // Firebase
  function initializeFirebase() {
    try {
      if (!firebaseApp) {
        firebaseApp = firebase.initializeApp(firebaseConfig);
      }
      database = firebase.database();
      console.log("Firebase inicializado com sucesso");
      
      loadFromFirebase();
      return true;
    } catch (error) {
      console.error("Erro ao inicializar Firebase:", error);
      loadState();
      render();
      renderChips();
      renderSorteioSection();
      return false;
    }
  }

  function loadFromFirebase() {
    if (!database) {
      console.log("Firebase não disponível, usando dados locais");
      loadState();
      render();
      renderChips();
      renderSorteioSection();
      return;
    }
    
    database.ref('menuData').once('value')
      .then((snapshot) => {
        const remoteData = snapshot.val();
        if (remoteData) {
          console.log("Dados carregados do Firebase");
          state = remoteData;
          applyTheme();
          renderChips();
          render();
          updateStatus();
          renderGeneralMessage();
          renderPromoBanner();
          renderStoreClosedMessage();
          renderSorteioSection();
        } else {
          console.log("Nenhum dado no Firebase, usando dados locais");
          loadState();
          render();
          renderChips();
          renderSorteioSection();
        }
        
        setupRealtimeListener();
      })
      .catch((error) => {
        console.error("Erro ao carregar do Firebase:", error);
        loadState();
        render();
        renderChips();
        renderSorteioSection();
      });
  }

  function setupRealtimeListener() {
    if (!database) return;
    
    database.ref('menuData').on('value', (snapshot) => {
      const remoteData = snapshot.val();
      if (remoteData) {
        console.log("Dados recebidos do Firebase em tempo real");
        state = remoteData;
        applyTheme();
        renderChips();
        render();
        updateStatus();
        renderGeneralMessage();
        renderPromoBanner();
        renderStoreClosedMessage();
        renderSorteioSection();
        
        if (isAdmin) {
          renderProdutosAdmin();
          renderCategoriesAdmin();
          renderSorteioAdmin();
        }
      }
    }, (error) => {
      console.error("Erro ao escutar atualizações:", error);
    });
  }

  function saveToFirebase() {
    if (!database) {
      console.log("Firebase não disponível, salvando apenas localmente");
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      return;
    }
    
    try {
      database.ref('menuData').set(state)
        .then(() => console.log("Dados salvos no Firebase"))
        .catch(error => console.error("Erro ao salvar no Firebase:", error));
    } catch (error) {
      console.error("Erro ao salvar no Firebase:", error);
    }
  }

  function loadState(){
    try{
      const saved = localStorage.getItem(LS_KEY);
      if(saved) {
        const parsed = JSON.parse(saved);
        state = {
          settings: { ...DEFAULT_SETTINGS, ...parsed.settings },
          products: parsed.products || [...DEFAULT_PRODUCTS]
        };
        
        if (!state.settings.sorteio) {
          state.settings.sorteio = {...DEFAULT_SETTINGS.sorteio};
        }
        
        return state;
      }
    }catch(e){
      console.error("Erro ao carregar estado:", e);
    }
    
    state = { settings: {...DEFAULT_SETTINGS}, products:[...DEFAULT_PRODUCTS] };
    return state;
  }

  function loadAddress(){
    try{
      const saved = localStorage.getItem(LS_ADDRESS_KEY);
      if(saved) return JSON.parse(saved);
    }catch(e){}
    return null;
  }

  function saveAddress(){
    if(enderecoSalvo) {
      localStorage.setItem(LS_ADDRESS_KEY, JSON.stringify(enderecoSalvo));
    } else {
      localStorage.removeItem(LS_ADDRESS_KEY);
    }
  }

  function persist(){ 
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    saveToFirebase();
  }

  function applyTheme(){
    $('#brandName').textContent = state.settings.name;
    $('#brandTag').textContent = state.settings.tag;
    $('#brandLogo').style.backgroundImage = `url('${state.settings.logo}')`;
  }

  function renderGeneralMessage() {
    const messageEl = $('#generalMessage');
    if (state.settings.message && state.settings.message.trim() !== '') {
      messageEl.style.display = 'block';
      messageEl.textContent = state.settings.message;
    } else {
      messageEl.style.display = 'none';
    }
  }

  function renderStoreClosedMessage() {
    const messageEl = $('#storeClosedMessage');
    if (state.settings.open === 'closed') {
      messageEl.style.display = 'block';
    } else {
      messageEl.style.display = 'none';
    }
  }

  function renderPromoBanner() {
    const promoEl = $('#promoBanner');
    const promoClosed = localStorage.getItem(LS_PROMO_CLOSED);
    
    if (state.settings.promo && state.settings.promo.active && state.settings.promo.title && !promoClosed) {
      promoEl.style.display = 'block';
      $('#promoTitle').textContent = state.settings.promo.title;
      $('#promoDescription').textContent = state.settings.promo.description;
      if (state.settings.promo.image) {
        $('#promoImage').src = state.settings.promo.image;
        $('#promoImage').style.display = 'block';
      } else {
        $('#promoImage').style.display = 'none';
      }
    } else {
      promoEl.style.display = 'none';
    }
  }

  function closePromoBanner() {
    $('#promoBanner').style.display = 'none';
    localStorage.setItem(LS_PROMO_CLOSED, 'true');
  }

  function renderSorteioSection() {
    const sorteioEl = $('#sorteioSection');
    const sorteioTitulo = $('.sorteio-title');
    const sorteioSubtitulo = $('.sorteio-subtitle');
    
    if (!state.settings.sorteio) {
      state.settings.sorteio = {...DEFAULT_SETTINGS.sorteio};
    }
    
    if (state.settings.sorteio.active) {
      sorteioEl.style.display = 'block';
      
      if (state.settings.sorteio.titulo) {
        sorteioTitulo.textContent = state.settings.sorteio.titulo;
      }
      
      if (state.settings.sorteio.descricao) {
        sorteioSubtitulo.textContent = state.settings.sorteio.descricao;
      }
      
      const count = state.settings.sorteio.participantes ? state.settings.sorteio.participantes.length : 0;
      $('#participantesCount').textContent = count;
      
      $('#sorteioSuccess').style.display = 'none';
      $('#sorteioForm').style.display = 'grid';
    } else {
      sorteioEl.style.display = 'none';
    }
  }

  function renderSorteioAdmin() {
    const count = state.settings.sorteio.participantes ? state.settings.sorteio.participantes.length : 0;
    $('#adminParticipantesCount').textContent = count;
  }

  function renderChips(){
    const box = $('#chips'); 
    box.innerHTML = '';
    
    const categorias = ['Todos'];
    state.products.forEach(prod => {
      if (prod.cat && !categorias.includes(prod.cat)) {
        categorias.push(prod.cat);
      }
    });
    
    categorias.forEach(cat => {
      const chip = document.createElement('div');
      chip.className = 'chip' + (filtroCat===cat?' active':'');
      chip.textContent = cat;
      chip.onclick = () => { filtroCat = cat; render(); };
      box.appendChild(chip);
    });
  }

  // RENDER PRINCIPAL CORRIGIDO - BOTÕES VISÍVEIS E FUNCIONAIS
  function render(){
    const q = ($('#q').value || '').toLowerCase();
    const grid = $('#grid'); 
    grid.innerHTML = '';

    const produtosFiltrados = state.products.filter(prod => {
      const categoriaMatch = filtroCat === 'Todos' || prod.cat === filtroCat;
      const buscaMatch = !q || 
        (prod.name && prod.name.toLowerCase().includes(q)) || 
        (prod.desc && prod.desc.toLowerCase().includes(q)) || 
        (prod.cat && prod.cat.toLowerCase().includes(q));
      return categoriaMatch && buscaMatch;
    });

    if(produtosFiltrados.length === 0){
      grid.innerHTML = '<div class="empty">Nenhum produto encontrado</div>';
      return;
    }

    produtosFiltrados.forEach(prod => {
      const card = document.createElement('div');
      card.className = 'card' + (prod.available ? '' : ' disabled');
      
      // CORREÇÃO: Criar a estrutura completa primeiro
      card.innerHTML = `
        ${!prod.available ? '<div class="availability-badge">INDISPONÍVEL</div>' : ''}
        <div class="thumb"></div>
        <div class="info">
          <div class="title">${prod.name}</div>
          <div class="desc">${prod.desc||''}</div>
          <div class="full-desc">${prod.desc||''}</div>
          ${prod.desc && prod.desc.length > 60 ? '<div class="show-details" onclick="toggleDetails(this)">Ver ingredientes</div>' : ''}
          <div class="row">
            <div class="price">${money(prod.price)}</div>
            <button class="btn" data-id="${prod.id}" ${(prod.available && state.settings.open === 'open') ? '' : 'disabled'}>
              ${(prod.available && state.settings.open === 'open') ? 'Add' : 'Indisponível'}
            </button>
          </div>
        </div>`;
      
      // Agora carregar a imagem na thumb
      const thumbDiv = card.querySelector('.thumb');
      loadProductImage(thumbDiv, prod);
      
      // CORREÇÃO: Eventos corrigidos - botão funciona separadamente
      const button = card.querySelector('button');
      if (prod.available && state.settings.open === 'open') {
        button.onclick = (e) => {
          e.stopPropagation(); // Impede que o clique no botão abra o modal
          addToCart(prod);
        };
      }
      
      // CORREÇÃO: Clique no card abre modal, mas não no botão
      card.addEventListener('click', (e) => {
        // Só abre modal se não foi clique no botão ou no link de detalhes
        if (!e.target.classList.contains('btn') && 
            !e.target.classList.contains('show-details') &&
            e.target.tagName !== 'BUTTON') {
          openProductModal(prod);
        }
      });
      
      grid.appendChild(card);
    });

    $('#cartCount').textContent = carrinho.reduce((total, item) => total + item.qty, 0);
    updateStatus();
    renderStoreClosedMessage();
  }

  function toggleDetails(element) {
    const card = element.closest('.card');
    const fullDesc = card.querySelector('.full-desc');
    const desc = card.querySelector('.desc');
    
    if (fullDesc.style.display === 'block') {
      fullDesc.style.display = 'none';
      desc.style.display = '-webkit-box';
      element.textContent = 'Ver ingredientes';
    } else {
      fullDesc.style.display = 'block';
      desc.style.display = 'none';
      element.textContent = 'Ocultar ingredientes';
    }
  }

  function updateStatus(){
    const aberto = state.settings.open === 'open';
    $('#statusText').textContent = aberto ? 'Aberto agora' : 'Fechado no momento';
    $('#statusDot').style.background = aberto ? 'var(--ok)' : 'var(--danger)';
  }

  function openProductModal(produto) {
    currentProduct = produto;
    modalQty = 1;
    
    const modalImage = $('#modalProductImage');
    modalImage.src = produto.img;
    modalImage.onerror = function() {
      this.src = getFallbackImage(produto.cat);
    };
    
    $('#modalProductName').textContent = produto.name;
    $('#modalProductDesc').textContent = produto.desc || '';
    $('#modalProductPrice').textContent = money(produto.price);
    $('#modalQty').textContent = modalQty;
    updateModalTotalPrice();
    
    $('#productModal').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeProductModal() {
    $('#productModal').classList.remove('open');
    document.body.style.overflow = 'auto';
    currentProduct = null;
  }

  function changeModalQty(delta) {
    const newQty = modalQty + delta;
    if (newQty >= 1 && newQty <= 20) {
      modalQty = newQty;
      $('#modalQty').textContent = modalQty;
      updateModalTotalPrice();
    }
  }

  function updateModalTotalPrice() {
    const total = currentProduct.price * modalQty;
    $('#modalTotalPrice').textContent = money(total);
  }

  function addFromModal() {
    if (!currentProduct) return;
    
    for (let i = 0; i < modalQty; i++) {
      addToCart(currentProduct);
    }
    
    closeProductModal();
  }

  function addToCart(produto){
    if (state.settings.open !== 'open') {
      alert('A loja está fechada no momento. Não é possível adicionar itens ao carrinho.');
      return;
    }
    
    if (!produto.available) return;
    
    const itemExistente = carrinho.find(item => item.id === produto.id);
    if(itemExistente){
      itemExistente.qty++;
    }else{
      carrinho.push({
        id: produto.id,
        name: produto.name,
        price: produto.price,
        qty: 1
      });
    }
    render();
    
    // Feedback visual
    const button = document.querySelector(`[data-id="${produto.id}"]`);
    if (button) {
      button.classList.add('btn-primary');
      setTimeout(() => {
        if (button) button.classList.remove('btn-primary');
      }, 300);
    }
  }

  function changeQty(id, delta){
    const item = carrinho.find(item => item.id === id);
    if(item){
      item.qty += delta;
      if(item.qty <= 0){
        carrinho = carrinho.filter(item => item.id !== id);
      }
      renderCart();
      render();
    }
  }

  function openCart(){
    $('#sheet').classList.add('open');
    renderCart();
    document.body.style.overflow = 'hidden';
  }

  function closeCart(){
    $('#sheet').classList.remove('open');
    document.body.style.overflow = 'auto';
  }

  function toggleAddressForm(){
    mostrarFormEndereco = !mostrarFormEndereco;
    renderCart();
  }

  function saveAddressForm(){
    const nome = $('#enderecoNome').value.trim();
    const rua = $('#enderecoRua').value.trim();
    const numero = $('#enderecoNumero').value.trim();
    const complemento = $('#enderecoComplemento').value.trim();
    const bairro = $('#enderecoBairro').value.trim();
    const referencia = $('#enderecoReferencia').value.trim();
    
    if(!nome || !rua || !numero || !bairro) {
      alert('Por favor, preencha pelo menos nome, rua, número e bairro.');
      return;
    }
    
    enderecoSalvo = {
      nome,
      rua,
      numero,
      complemento,
      bairro,
      referencia
    };
    
    saveAddress();
    mostrarFormEndereco = false;
    renderCart();
  }

  function clearAddress(){
    enderecoSalvo = null;
    saveAddress();
    renderCart();
  }

  function renderCart(){
    const body = $('#cartBody');
    body.innerHTML = '';
    
    if(carrinho.length === 0){
      body.innerHTML = '<div class="muted">Seu carrinho está vazio.</div>';
      return;
    }
    
    let subtotal = 0;
    carrinho.forEach(item => {
      const totalItem = item.price * item.qty;
      subtotal += totalItem;
      
      const produto = state.products.find(p => p.id === item.id);
      const descricao = produto ? produto.desc : '';
      
      const linha = document.createElement('div');
      linha.className = 'cart-line';
      linha.innerHTML = `
        <div>
          <b>${item.name}</b>
          ${descricao ? `<br><small class="muted" style="font-size: 11px;">${descricao}</small>` : ''}
          <br><small class="muted">${money(item.price)} x ${item.qty}</small>
        </div>
        <div class="qty">
          <button class="btn" onclick="changeQty('${item.id}', -1)">-</button>
          <span>${item.qty}</span>
          <button class="btn" onclick="changeQty('${item.id}', 1)">+</button>
        </div>
        <div><b>${money(totalItem)}</b></div>`;
      body.appendChild(linha);
    });
    
    const frete = subtotal >= state.settings.frete_free ? 0 : state.settings.frete;
    const total = subtotal + frete;
    
    let freteMessage = '';
    if (frete === 0) {
      freteMessage = `<div class="free-delivery-message" style="margin: 12px 0;">
        <i class="fas fa-truck"></i> <b>Entrega grátis</b> - Parabéns! Seu pedido atingiu o valor mínimo de ${money(state.settings.frete_free)}.
      </div>`;
    } else {
      const valorRestante = state.settings.frete_free - subtotal;
      freteMessage = `<div class="muted" style="text-align:center; padding: 8px; background: rgba(212,175,55,0.05); border-radius: 8px; margin: 12px 0;">
        <i class="fas fa-info-circle"></i> Faltam ${money(valorRestante)} para ganhar <b>frete grátis</b>
      </div>`;
    }
    
    body.innerHTML += `
      <div class="total"><div>Subtotal</div><div>${money(subtotal)}</div></div>
      ${freteMessage}
      <div class="total"><div>Frete</div><div>${frete === 0 ? 'GRÁTIS' : money(frete)}</div></div>
      <div class="total"><div>Total</div><div>${money(total)}</div></div>`;
    
    body.innerHTML += `
      <div class="address-form">
        <h3>Endereço de entrega</h3>
        ${enderecoSalvo && !mostrarFormEndereco ? `
          <div class="address-saved">
            <p><b>${enderecoSalvo.nome}</b></p>
            <p>${enderecoSalvo.rua}, ${enderecoSalvo.numero} ${enderecoSalvo.complemento ? '- ' + enderecoSalvo.complemento : ''}</p>
            <p>${enderecoSalvo.bairro}</p>
            ${enderecoSalvo.referencia ? `<p>Ref: ${enderecoSalvo.referencia}</p>` : ''}
            <span class="edit-address" onclick="toggleAddressForm()">Alterar endereço</span>
          </div>
        ` : `
          <div class="address-toggle" onclick="toggleAddressForm()">
            <input type="checkbox" ${mostrarFormEndereco ? 'checked' : ''}>
            <span>Adicionar endereço de entrega</span>
          </div>
        `}
        
        ${mostrarFormEndereco ? `
          <div class="address-fields">
            <div class="field">
              <label>Nome para entrega</label>
              <input type="text" id="enderecoNome" value="${enderecoSalvo ? enderecoSalvo.nome : ''}" placeholder="Seu nome">
            </div>
            <div class="field">
              <label>Rua</label>
              <input type="text" id="enderecoRua" value="${enderecoSalvo ? enderecoSalvo.rua : ''}" placeholder="Nome da rua">
            </div>
            <div class="field">
              <label>Número</label>
              <input type="text" id="enderecoNumero" value="${enderecoSalvo ? enderecoSalvo.numero : ''}" placeholder="Número">
            </div>
            <div class="field">
              <label>Complemento</label>
              <input type="text" id="enderecoComplemento" value="${enderecoSalvo ? enderecoSalvo.complemento : ''}" placeholder="Apto, bloco, etc.">
            </div>
            <div class="field">
              <label>Bairro</label>
              <input type="text" id="enderecoBairro" value="${enderecoSalvo ? enderecoSalvo.bairro : ''}" placeholder="Bairro">
            </div>
            <div class="field">
              <label>Ponto de referência</label>
              <input type="text" id="enderecoReferencia" value="${enderecoSalvo ? enderecoSalvo.referencia : ''}" placeholder="Perto de...">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; grid-column: 1 / span 2;">
              ${enderecoSalvo ? `<button class="btn" onclick="clearAddress()">Limpar</button>` : ''}
              <button class="btn btn-primary" onclick="saveAddressForm()">Salvar endereço</button>
            </div>
          </div>
        ` : ''}
      </div>
      
      <textarea id="obs" placeholder="Observações do pedido" style="
        width:100%; min-height:80px; margin-top:12px; padding:10px; 
        border-radius:12px; background:#0f0f12; color:#fff; 
        border:1px solid rgba(212,175,55,.25); resize:vertical;
      "></textarea>
      
      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
        <button class="btn" onclick="closeCart()">Continuar comprando</button>
        <button class="btn btn-primary" onclick="sendWhatsApp()" ${state.settings.open !== 'open' ? 'disabled' : ''}>Finalizar no WhatsApp</button>
      </div>`;
      
    if (state.settings.open !== 'open') {
      body.innerHTML += `
        <div class="store-closed-message" style="margin-top: 16px;">
          <b>Loja Fechada</b> - No momento não estamos aceitando pedidos. Volte em breve!
        </div>
      `;
    }
  }

  function sendWhatsApp(){
    if (state.settings.open !== 'open') {
      alert('A loja está fechada no momento. Não é possível finalizar pedidos.');
      return;
    }
    
    if(carrinho.length === 0) return;
    
    const numero = state.settings.whatsapp.replace(/\D/g, '');
    if(!numero){
      alert('Configure o número do WhatsApp nas configurações');
      return;
    }
    
    let mensagem = `*Pedido ${state.settings.name}*%0A%0A`;
    
    carrinho.forEach(item => {
      const produto = state.products.find(p => p.id === item.id);
      const descricao = produto ? produto.desc : '';
      
      mensagem += `• ${item.qty}x ${item.name} - ${money(item.price * item.qty)}%0A`;
      if (descricao) {
        mensagem += `  _${descricao}_%0A`;
      }
    });
    
    const subtotal = carrinho.reduce((total, item) => total + (item.price * item.qty), 0);
    const frete = subtotal >= state.settings.frete_free ? 0 : state.settings.frete;
    const total = subtotal + frete;
    
    mensagem += `%0A*Subtotal:* ${money(subtotal)}%0A`;
    mensagem += `*Frete:* ${frete === 0 ? 'GRÁTIS' : money(frete)}%0A`;
    mensagem += `*Total:* ${money(total)}%0A`;
    
    if(enderecoSalvo){
      mensagem += `%0A*Endereço de entrega:*%0A`;
      mensagem += `${enderecoSalvo.nome}%0A`;
      mensagem += `${enderecoSalvo.rua}, ${enderecoSalvo.numero}`;
      if(enderecoSalvo.complemento) mensagem += ` - ${enderecoSalvo.complemento}`;
      mensagem += `%0A${enderecoSalvo.bairro}`;
      if(enderecoSalvo.referencia) mensagem += `%0ARef: ${enderecoSalvo.referencia}`;
    }
    
    const observacoes = $('#obs').value;
    if(observacoes){
      mensagem += `%0A%0A*Observações:* ${encodeURIComponent(observacoes)}`;
    }
    
    window.open(`https://wa.me/${numero}?text=${mensagem}`, '_blank');
    
    carrinho = [];
    render();
    renderCart();
    closeCart();
  }

  // FUNÇÕES DO SORTEIO
  function participarSorteio() {
    const nome = $('#sorteioNome').value.trim();
    const whatsapp = $('#sorteioWhatsApp').value.trim();
    
    if (!nome || !whatsapp) {
      alert('Por favor, preencha seu nome e WhatsApp para participar do sorteio.');
      return;
    }
    
    if (!state.settings.sorteio) {
      state.settings.sorteio = {...DEFAULT_SETTINGS.sorteio};
    }
    
    if (!state.settings.sorteio.participantes) {
      state.settings.sorteio.participantes = [];
    }
    
    const whatsappExistente = state.settings.sorteio.participantes.find(p => 
      p.whatsapp.replace(/\D/g, '') === whatsapp.replace(/\D/g, '')
    );
    
    if (whatsappExistente) {
      alert('Você já está participando do sorteio! Boa sorte!');
      return;
    }
    
    state.settings.sorteio.participantes.push({
      id: uid(),
      nome: nome,
      whatsapp: whatsapp,
      data: new Date().toISOString()
    });
    
    persist();
    
    $('#sorteioSuccess').style.display = 'block';
    $('#sorteioForm').style.display = 'none';
    
    $('#participantesCount').textContent = state.settings.sorteio.participantes.length;
    
    $('#sorteioNome').value = '';
    $('#sorteioWhatsApp').value = '';
  }

  function abrirSorteioModal() {
    if (!state.settings.sorteio.participantes || state.settings.sorteio.participantes.length === 0) {
      alert('Não há participantes para sortear.');
      return;
    }
    
    $('#sorteioModal').classList.add('open');
    document.body.style.overflow = 'hidden';
    
    $('#sorteioResultado').style.display = 'none';
    $('#roleta').style.transform = 'rotate(0deg)';
  }

  function fecharSorteio() {
    $('#sorteioModal').classList.remove('open');
    document.body.style.overflow = 'auto';
  }

  function sortearVencedor() {
    const participantes = state.settings.sorteio.participantes;
    if (!participantes || participantes.length === 0) return;
    
    $('#sortearBtn').disabled = true;
    
    const roleta = $('#roleta');
    const rotacoes = 5;
    const anguloPorParticipante = 360 / participantes.length;
    const indiceSorteado = Math.floor(Math.random() * participantes.length);
    const anguloFinal = (rotacoes * 360) + (indiceSorteado * anguloPorParticipante);
    
    roleta.style.transform = `rotate(${anguloFinal}deg)`;
    
    setTimeout(() => {
      const vencedor = participantes[indiceSorteado];
      
      $('#vencedorNome').textContent = vencedor.nome;
      $('#vencedorWhatsApp').textContent = vencedor.whatsapp;
      
      const numeroWhatsApp = vencedor.whatsapp.replace(/\D/g, '');
      $('#vencedorWhatsAppLink').href = `https://wa.me/${numeroWhatsApp}`;
      
      $('#sorteioResultado').style.display = 'block';
      $('#sortearBtn').disabled = false;
    }, 4000);
  }

  function exportarParticipantes() {
    if (!state.settings.sorteio.participantes || state.settings.sorteio.participantes.length === 0) {
      alert('Não há participantes para exportar.');
      return;
    }
    
    const dados = state.settings.sorteio.participantes.map(p => ({
      Nome: p.nome,
      WhatsApp: p.whatsapp,
      Data: new Date(p.data).toLocaleString('pt-BR')
    }));
    
    const csv = convertToCSV(dados);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `participantes-sorteio-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function convertToCSV(objArray) {
    const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
    let str = 'Nome,WhatsApp,Data de Inscrição\r\n';
    
    for (let i = 0; i < array.length; i++) {
      let line = '';
      for (let index in array[i]) {
        if (line !== '') line += ',';
        line += array[i][index];
      }
      str += line + '\r\n';
    }
    
    return str;
  }

  function limparParticipantes() {
    if (confirm('Tem certeza que deseja limpar todos os participantes? Esta ação não pode ser desfeita.')) {
      state.settings.sorteio.participantes = [];
      persist();
      renderSorteioAdmin();
      renderSorteioSection();
      alert('Participantes removidos com sucesso.');
    }
  }

  function toggleSorteioSection() {
    const active = $('#st_sorteio_active').value === 'true';
    state.settings.sorteio.active = active;
    persist();
    renderSorteioSection();
  }

  // Admin
  document.getElementById('adminBtn').addEventListener('click', function() {
    $('#adminPass').value = '';
    $('#loginError').style.display = 'none';
    $('#loginBack').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  });

  function hideLogin(){
    $('#loginBack').style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  function checkLogin(){
    const senha = $('#adminPass').value;
    if(senha === ADMIN_PASSWORD){
      isAdmin = true;
      hideLogin();
      openAdmin();
    }else{
      $('#loginError').style.display = 'block';
    }
  }

  function openAdmin(){
    $('#st_name').value = state.settings.name;
    $('#st_tag').value = state.settings.tag;
    $('#st_logo').value = state.settings.logo;
    $('#st_wa').value = state.settings.whatsapp;
    $('#st_frete').value = state.settings.frete;
    $('#st_free').value = state.settings.frete_free;
    $('#st_open').value = state.settings.open;
    $('#st_message').value = state.settings.message || '';
    
    $('#st_promo_title').value = state.settings.promo?.title || '';
    $('#st_promo_desc').value = state.settings.promo?.description || '';
    $('#st_promo_img').value = state.settings.promo?.image || '';
    $('#st_promo_active').value = state.settings.promo?.active ? 'true' : 'false';
    
    $('#st_sorteio_active').value = state.settings.sorteio?.active ? 'true' : 'false';
    $('#st_sorteio_titulo').value = state.settings.sorteio?.titulo || '';
    $('#st_sorteio_desc').value = state.settings.sorteio?.descricao || '';
    $('#st_sorteio_data').value = state.settings.sorteio?.data || '';
    
    renderProdutosAdmin();
    renderCategoriesAdmin();
    renderSorteioAdmin();
    
    $('#adminBack').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeAdmin(){
    $('#adminBack').style.display = 'none';
    document.body.style.overflow = 'auto';
    isAdmin = false;
  }

  function saveAll(){
    state.settings.name = $('#st_name').value.trim();
    state.settings.tag = $('#st_tag').value.trim();
    state.settings.logo = $('#st_logo').value.trim();
    state.settings.whatsapp = $('#st_wa').value.replace(/\D/g, '');
    state.settings.frete = Number($('#st_frete').value) || 0;
    state.settings.frete_free = Number($('#st_free').value) || 0;
    state.settings.open = $('#st_open').value;
    state.settings.message = $('#st_message').value.trim();
    
    state.settings.promo = {
      title: $('#st_promo_title').value.trim(),
      description: $('#st_promo_desc').value.trim(),
      image: $('#st_promo_img').value.trim(),
      active: $('#st_promo_active').value === 'true'
    };
    
    state.settings.sorteio.titulo = $('#st_sorteio_titulo').value.trim();
    state.settings.sorteio.descricao = $('#st_sorteio_desc').value.trim();
    state.settings.sorteio.data = $('#st_sorteio_data').value;
    
    const categoryInputs = $$('#categoriesList input');
    state.settings.categories = Array.from(categoryInputs)
      .map(input => input.value.trim())
      .filter(cat => cat !== '');
    
    persist();
    applyTheme();
    render();
    renderChips();
    renderGeneralMessage();
    renderPromoBanner();
    renderStoreClosedMessage();
    renderSorteioSection();
    alert('Configurações salvas com sucesso! As alterações serão sincronizadas com todos os dispositivos.');
  }

  function renderCategoriesAdmin() {
    const container = $('#categoriesList');
    container.innerHTML = '';
    
    if (!state.settings.categories) {
      state.settings.categories = [...DEFAULT_SETTINGS.categories];
    }
    
    state.settings.categories.forEach((cat, index) => {
      const field = document.createElement('div');
      field.className = 'field';
      field.innerHTML = `
        <label>Categoria ${index + 1}</label>
        <input value="${cat}" placeholder="Nome da categoria" onchange="updateCategory(${index}, this.value)">
      `;
      container.appendChild(field);
    });
  }

  function updateCategory(index, value) {
    state.settings.categories[index] = value.trim();
    state.settings.categories = state.settings.categories.filter(cat => cat !== '');
    persist();
  }

  function addCategoryField() {
    const container = $('#categoriesList');
    const field = document.createElement('div');
    field.className = 'field';
    field.innerHTML = `
      <label>Nova Categoria</label>
      <input placeholder="Nome da categoria" onchange="addNewCategory(this.value)">
    `;
    container.appendChild(field);
  }

  function addNewCategory(value) {
    if (value.trim() !== '') {
      state.settings.categories.push(value.trim());
      persist();
      renderCategoriesAdmin();
    }
  }

  function renderProdutosAdmin(){
    const container = $('#prodList');
    container.innerHTML = '';
    
    if(state.products.length === 0){
      container.innerHTML = '<div class="empty">Nenhum produto cadastrado</div>';
      return;
    }
    
    state.products.forEach((prod, index) => {
      const produtoElement = document.createElement('div');
      produtoElement.className = 'order-card';
      produtoElement.style.marginBottom = '12px';
      produtoElement.innerHTML = `
        <div class="grid-2">
          <div class="field">
            <label>Nome</label>
            <input value="${prod.name || ''}" placeholder="Nome do produto" onchange="updateProductField(${index}, 'name', this.value)">
          </div>
          <div class="field">
            <label>Preço (R$)</label>
            <input value="${prod.price || 0}" type="number" step="0.01" min="0" onchange="updateProductField(${index}, 'price', this.value)">
          </div>
          <div class="field">
            <label>Descrição</label>
            <textarea onchange="updateProductField(${index}, 'desc', this.value)" placeholder="Descrição completa com ingredientes">${prod.desc || ''}</textarea>
          </div>
          <div class="field">
            <label>Categoria</label>
            <select onchange="updateProductField(${index}, 'cat', this.value)">
              ${state.settings.categories.map(cat => 
                `<option value="${cat}" ${prod.cat === cat ? 'selected' : ''}>${cat}</option>`
              ).join('')}
            </select>
          </div>
          <div class="field">
            <label>Imagem (URL)</label>
            <input value="${prod.img || ''}" placeholder="URL da imagem" onchange="updateProductField(${index}, 'img', this.value)">
          </div>
          <div class="field">
            <label>Disponível</label>
            <select onchange="updateProductField(${index}, 'available', this.value === 'true')">
              <option value="true" ${prod.available ? 'selected' : ''}>Sim</option>
              <option value="false" ${!prod.available ? 'selected' : ''}>Não</option>
            </select>
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:12px; justify-content: flex-end;">
          <button class="btn" onclick="removerProduto(${index})" style="border-color:rgba(255,92,92,.5)">Remover</button>
        </div>
        <div class="hr"></div>
      `;
      
      container.appendChild(produtoElement);
    });
  }

  function updateProductField(index, field, value) {
    if (field === 'price') {
      state.products[index][field] = Number(value);
    } else if (field === 'available') {
      state.products[index][field] = value === 'true' || value === true;
    } else {
      state.products[index][field] = value;
    }
    persist();
  }

  function removerProduto(index){
    if(confirm('Tem certeza que deseja remover este produto?')){
      state.products.splice(index, 1);
      persist();
      renderProdutosAdmin();
    }
  }

  function addProduct(){
    const novoProduto = {
      id: uid(),
      name: 'Novo Produto',
      desc: '',
      price: 0,
      cat: state.settings.categories[0] || 'Pizzas',
      img: '',
      available: true
    };
    state.products.unshift(novoProduto);
    persist();
    renderProdutosAdmin();
  }

  function exportBackup(){
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'backup-bravetto.json';
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 100);
  }

  document.getElementById('importFile').addEventListener('change', function(e){
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const dados = JSON.parse(e.target.result);
        if(dados.settings && dados.products){
          state = dados;
          persist();
          applyTheme();
          renderChips();
          render();
          renderGeneralMessage();
          renderPromoBanner();
          renderStoreClosedMessage();
          renderSorteioSection();
          closeAdmin();
          alert('Backup importado com sucesso!');
        }else{
          alert('Arquivo inválido');
        }
      }catch(error){
        alert('Erro ao ler o arquivo: ' + error.message);
      }
    };
    reader.readAsText(file);
    this.value = '';
  });

  function resetAll(){
    if(confirm('Tem certeza que deseja resetar para os valores padrão? Todos os dados atuais serão perdidos.')){
      state = { settings: {...DEFAULT_SETTINGS}, products: [...DEFAULT_PRODUCTS] };
      persist();
      applyTheme();
      render();
      renderChips();
      renderGeneralMessage();
      renderPromoBanner();
      renderStoreClosedMessage();
      renderSorteioSection();
      closeAdmin();
      alert('Sistema resetado para os valores padrão');
    }
  }

  // Inicialização
  document.addEventListener('DOMContentLoaded', function(){
    enderecoSalvo = loadAddress();
    
    initializeFirebase();
    
    $('#loginBack').addEventListener('click', function(e){
      if(e.target === this) hideLogin();
    });
    
    $('#adminBack').addEventListener('click', function(e){
      if(e.target === this) closeAdmin();
    });
    
    $('#productModal').addEventListener('click', function(e){
      if(e.target === this) closeProductModal();
    });
    
    $('#sorteioModal').addEventListener('click', function(e){
      if(e.target === this) fecharSorteio();
    });
    
    document.getElementById('participarSorteio').addEventListener('click', participarSorteio);
    
    document.getElementById('sortearBtn').addEventListener('click', sortearVencedor);
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if ($('#loginBack').style.display === 'flex') hideLogin();
        if ($('#adminBack').style.display === 'flex') closeAdmin();
        if ($('#sheet').classList.contains('open')) closeCart();
        if ($('#productModal').classList.contains('open')) closeProductModal();
        if ($('#sorteioModal').classList.contains('open')) fecharSorteio();
      }
    });
    
    render();
    renderChips();
    renderSorteioSection();
  });
  </script>
</body>
</html>
