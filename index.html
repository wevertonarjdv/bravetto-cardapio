// Configurações iniciais
const ADMIN_PASSWORD = 'admin123'; // Senha padrão para acesso administrativo
const LS_KEY = 'bravetto_menu_v1';
const LS_ADDRESS_KEY = 'bravetto_address';

// Configuração do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCimABHZZvGT-W4b_ouEieF0XiizLo6DVw",
  authDomain: "cardapiobravetto.firebaseapp.com",
  databaseURL: "https://cardapiobravetto-default-rtdb.firebaseio.com",
  projectId: "cardapiobravetto",
  storageBucket: "cardapiobravetto.firebasestorage.app",
  messagingSenderId: "303652377735",
  appId: "1:303652377735:web:f0af28ded5d3b731881422",
  measurementId: "G-PNTPM6DESN"
};

const DEFAULT_SETTINGS = {
  name:'Bravetto',
  tag:'Pizzas • Hambúrgueres • Delivery',
  logo:'https://raw.githubusercontent.com/finetuner-oss/storage/main/brand/bravetto-gold.png',
  whatsapp:'5534991301417',
  frete:5,
  frete_free:60,
  open:'open'
};

const DEFAULT_PRODUCTS = [
  {id:'pz-marg', name:'Pizza Margherita', desc:'Molho de tomate, muçarela, manjericão fresco.', price:39.90, cat:'Pizzas', img:'https://images.unsplash.com/photo-1542281286-9e0a16bb7366?q=80&w=500&auto=format&fit=crop', available:true},
  {id:'pz-calab', name:'Pizza Calabresa', desc:'Calabresa fatiada, cebola, azeitona.', price:44.90, cat:'Pizzas', img:'https://images.unsplash.com/photo-1628840042765-356cda07504e?q=80&w=500&auto=format&fit=crop', available:true},
  {id:'pz-frango', name:'Pizza Frango c/ Catupiry', desc:'Frango desfiado, catupiry, milho, orégano.', price:49.90, cat:'Pizzas', img:'https://images.unsplash.com/photo-1541746972996-4e0b0f43e02a?q=80&w=500&auto=format&fit=crop', available:true},
  {id:'hb-smash', name:'Hambúrguer Smash', desc:'Carne smash 120g, queijo, picles e molho da casa.', price:27.90, cat:'Hambúrgueres', img:'https://images.unsplash.com/photo-1550547660-d9450f859349?q=80&w=500&auto=format&fit=crop', available:true},
  {id:'hb-bacon', name:'Cheese Bacon', desc:'Pão brioche, blend 160g, queijo duplo, bacon crocante.', price:31.90, cat:'Hambúrgueres', img:'https://images.unsplash.com/photo-1553979459-d2229ba7433b?q=80&w=500&auto=format&fit=crop', available:true},
  {id:'bd-lata', name:'Refrigerante Lata', desc:'Coca-Cola, Guaraná, Fanta... (350ml).', price:7.90, cat:'Bebidas', img:'https://images.unsplash.com/photo-1622484212603-c5aa0dbf9296?q=80&w=500&auto=format&fit=crop', available:true},
  {id:'cb-duo', name:'Combo Duo', desc:'1 Pizza média + 2 latas de refri.', price:69.90, cat:'Combos', img:'https://images.unsplash.com/photo-1561758033-d89a9ad46330?q=80&w=500&auto=format&fit=crop', available:true}
];

let state = { settings: {...DEFAULT_SETTINGS}, products:[...DEFAULT_PRODUCTS] };
let carrinho = [];
let filtroCat = 'Todos';
let isAdmin = false;
let firebaseApp;
let database;

// Utilitários
function $(sel) { return document.querySelector(sel); }
function $$(sel) { return document.querySelectorAll(sel); }
function money(v) { return (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function uid() { return 'id' + Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-3); }

// Inicialização do Firebase
function initializeFirebase() {
  try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    console.log("Firebase inicializado com sucesso");
    
    // Carregar dados do Firebase
    loadFromFirebase();
    return true;
  } catch (error) {
    console.error("Erro ao inicializar Firebase:", error);
    // Continuar com funcionalidade local mesmo sem Firebase
    return false;
  }
}

// Carregar dados do Firebase
function loadFromFirebase() {
  if (!database) return;
  
  database.ref('menuData').once('value')
    .then((snapshot) => {
      const remoteData = snapshot.val();
      if (remoteData) {
        console.log("Dados carregados do Firebase");
        state = remoteData;
        applyTheme();
        renderChips();
        render();
        updateStatus();
      }
      
      // Configurar listener para atualizações em tempo real
      setupRealtimeListener();
    })
    .catch((error) => {
      console.error("Erro ao carregar do Firebase:", error);
    });
}

// Configurar listener para atualizações em tempo real
function setupRealtimeListener() {
  if (!database) return;
  
  database.ref('menuData').on('value', (snapshot) => {
    const remoteData = snapshot.val();
    if (remoteData) {
      console.log("Dados recebidos do Firebase em tempo real");
      state = remoteData;
      applyTheme();
      renderChips();
      render();
      updateStatus();
      
      // Se estiver no painel admin, atualizar a lista de produtos também
      if (isAdmin) {
        renderProdutosAdmin();
      }
    }
  }, (error) => {
    console.error("Erro ao escutar atualizações:", error);
  });
}

// Salvar dados no Firebase
function saveToFirebase() {
  if (!database) return;
  
  try {
    database.ref('menuData').set(state)
      .then(() => console.log("Dados salvos no Firebase"))
      .catch(error => console.error("Erro ao salvar no Firebase:", error));
  } catch (error) {
    console.error("Erro ao salvar no Firebase:", error);
  }
}

function loadState(){
  try{
    const saved = localStorage.getItem(LS_KEY);
    if(saved) return JSON.parse(saved);
  }catch(e){}
  return { settings: {...DEFAULT_SETTINGS}, products:[...DEFAULT_PRODUCTS] };
}

function persist(){ 
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  saveToFirebase(); // Salvar também no Firebase
}

function applyTheme(){
  $('#brandName').textContent = state.settings.name;
  $('#brandTag').textContent = state.settings.tag;
  $('#brandLogo').style.backgroundImage = `url('${state.settings.logo}')`;
}

// Renderização
function renderChips(){
  const box = $('#chips'); 
  box.innerHTML = '';
  
  // Extrair categorias únicas dos produtos
  const categorias = ['Todos'];
  state.products.forEach(prod => {
    if (prod.cat && !categorias.includes(prod.cat)) {
      categorias.push(prod.cat);
    }
  });
  
  categorias.forEach(cat => {
    const chip = document.createElement('div');
    chip.className = 'chip' + (filtroCat===cat?' active':'');
    chip.textContent = cat;
    chip.onclick = () => { filtroCat = cat; render(); };
    box.appendChild(chip);
  });
}

function render(){
  const q = ($('#q').value || '').toLowerCase();
  const grid = $('#grid'); 
  grid.innerHTML = '';

  const produtosFiltrados = state.products.filter(prod => {
    const categoriaMatch = filtroCat === 'Todos' || prod.cat === filtroCat;
    const buscaMatch = !q || 
      (prod.name && prod.name.toLowerCase().includes(q)) || 
      (prod.desc && prod.desc.toLowerCase().includes(q)) || 
      (prod.cat && prod.cat.toLowerCase().includes(q));
    return categoriaMatch && buscaMatch;
  });

  if(produtosFiltrados.length === 0){
    grid.innerHTML = '<div class="empty">Nenhum produto encontrado</div>';
    return;
  }

  produtosFiltrados.forEach(prod => {
    const card = document.createElement('div');
    card.className = 'card' + (prod.available ? '' : ' disabled');
    card.innerHTML = `
      ${!prod.available ? '<div class="availability-badge">INDISPONÍVEL</div>' : ''}
      <div class="thumb" style="background-image:url('${prod.img||''}')"></div>
      <div class="info">
        <div class="title">${prod.name}</div>
        <div class="desc">${prod.desc||''}</div>
        <div class="row">
          <div class="price">${money(prod.price)}</div>
          <button class="btn" data-id="${prod.id}" ${prod.available ? '' : 'disabled'}>Add</button>
        </div>
      </div>`;
    if (prod.available) {
      card.querySelector('button').onclick = () => addToCart(prod);
    }
    grid.appendChild(card);
  });

  $('#cartCount').textContent = carrinho.reduce((total, item) => total + item.qty, 0);
  updateStatus();
}

function updateStatus(){
  const aberto = state.settings.open === 'open';
  $('#statusText').textContent = aberto ? 'Aberto agora' : 'Fechado no momento';
  $('#statusDot').style.background = aberto ? 'var(--ok)' : 'var(--danger)';
}

// Carrinho
function addToCart(produto){
  if (!produto.available) return;
  
  const itemExistente = carrinho.find(item => item.id === produto.id);
  if(itemExistente){
    itemExistente.qty++;
  }else{
    carrinho.push({
      id: produto.id,
      name: produto.name,
      price: produto.price,
      qty: 1
    });
  }
  render();
  
  // Feedback visual - destaque no botão
  const button = document.querySelector(`[data-id="${produto.id}"]`);
  if (button) {
    button.classList.add('btn-primary');
    setTimeout(() => {
      if (button) button.classList.remove('btn-primary');
    }, 300);
  }
}

function changeQty(id, delta){
  const item = carrinho.find(item => item.id === id);
  if(item){
    item.qty += delta;
    if(item.qty <= 0){
      carrinho = carrinho.filter(item => item.id !== id);
    }
    renderCart();
    render();
  }
}

function openCart(){
  $('#sheet').classList.add('open');
  renderCart();
  document.body.style.overflow = 'hidden';
}

function closeCart(){
  $('#sheet').classList.remove('open');
  document.body.style.overflow = 'auto';
}

function renderCart(){
  const body = $('#cartBody');
  body.innerHTML = '';
  
  if(carrinho.length === 0){
    body.innerHTML = '<div class="muted">Seu carrinho está vazio.</div>';
    return;
  }
  
  let subtotal = 0;
  carrinho.forEach(item => {
    const totalItem = item.price * item.qty;
    subtotal += totalItem;
    
    const linha = document.createElement('div');
    linha.className = 'cart-line';
    linha.innerHTML = `
      <div><b>${item.name}</b><br><small class="muted">${money(item.price)} x ${item.qty}</small></div>
      <div class="qty">
        <button class="btn" onclick="changeQty('${item.id}', -1)">-</button>
        <span>${item.qty}</span>
        <button class="btn" onclick="changeQty('${item.id}', 1)">+</button>
      </div>
      <div><b>${money(totalItem)}</b></div>`;
    body.appendChild(linha);
  });
  
  const frete = subtotal >= state.settings.frete_free ? 0 : state.settings.frete;
  const total = subtotal + frete;
  
  body.innerHTML += `
    <div class="total"><div>Subtotal</div><div>${money(subtotal)}</div></div>
    <div class="total"><div>Frete</div><div>${frete === 0 ? 'GRÁTIS' : money(frete)}</div></div>
    <div class="total"><div>Total</div><div>${money(total)}</div></div>
    
    <textarea id="obs" placeholder="Observações do pedido" style="
      width:100%; min-height:80px; margin-top:12px; padding:10px; 
      border-radius:12px; background:#0f0f12; color:#fff; 
      border:1px solid rgba(212,175,55,.25); resize:vertical;
    "></textarea>
    
    <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
      <button class="btn" onclick="closeCart()">Continuar comprando</button>
      <button class="btn btn-primary" onclick="sendWhatsApp()">Finalizar no WhatsApp</button>
    </div>`;
}

function sendWhatsApp(){
  if(carrinho.length === 0) return;
  
  const numero = state.settings.whatsapp.replace(/\D/g, '');
  if(!numero){
    alert('Configure o número do WhatsApp nas configurações');
    return;
  }
  
  let mensagem = `*Pedido ${state.settings.name}*%0A%0A`;
  
  carrinho.forEach(item => {
    mensagem += `• ${item.qty}x ${item.name} - ${money(item.price * item.qty)}%0A`;
  });
  
  const subtotal = carrinho.reduce((total, item) => total + (item.price * item.qty), 0);
  const frete = subtotal >= state.settings.frete_free ? 0 : state.settings.frete;
  const total = subtotal + frete;
  
  mensagem += `%0A*Subtotal:* ${money(subtotal)}%0A`;
  mensagem += `*Frete:* ${frete === 0 ? 'GRÁTIS' : money(frete)}%0A`;
  mensagem += `*Total:* ${money(total)}%0A`;
  
  const observacoes = $('#obs').value;
  if(observacoes){
    mensagem += `%0A%0A*Observações:* ${encodeURIComponent(observacoes)}`;
  }
  
  // Abrir WhatsApp
  window.open(`https://wa.me/${numero}?text=${mensagem}`, '_blank');
  
  // Limpar carrinho após o pedido
  carrinho = [];
  render();
  renderCart();
  closeCart();
}

// Admin
$('#adminBtn').addEventListener('click', () => {
  $('#adminPass').value = '';
  $('#loginError').style.display = 'none';
  $('#loginBack').style.display = 'flex';
  document.body.style.overflow = 'hidden';
});

function hideLogin(){
  $('#loginBack').style.display = 'none';
  document.body.style.overflow = 'auto';
}

function checkLogin(){
  if($('#adminPass').value === ADMIN_PASSWORD){
    isAdmin = true;
    hideLogin();
    openAdmin();
  }else{
    $('#loginError').style.display = 'block';
  }
}

function openAdmin(){
  // Preencher configurações
  $('#st_name').value = state.settings.name;
  $('#st_tag').value = state.settings.tag;
  $('#st_logo').value = state.settings.logo;
  $('#st_wa').value = state.settings.whatsapp;
  $('#st_frete').value = state.settings.frete;
  $('#st_free').value = state.settings.frete_free;
  $('#st_open').value = state.settings.open;
  
  renderProdutosAdmin();
  
  $('#adminBack').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeAdmin(){
  $('#adminBack').style.display = 'none';
  document.body.style.overflow = 'auto';
  isAdmin = false;
}

function saveAll(){
  state.settings.name = $('#st_name').value.trim();
  state.settings.tag = $('#st_tag').value.trim();
  state.settings.logo = $('#st_logo').value.trim();
  state.settings.whatsapp = $('#st_wa').value.replace(/\D/g, '');
  state.settings.frete = Number($('#st_frete').value) || 0;
  state.settings.frete_free = Number($('#st_free').value) || 0;
  state.settings.open = $('#st_open').value;
  
  persist();
  applyTheme();
  render();
  renderChips();
  alert('Configurações salvas com sucesso! As alterações serão sincronizadas com todos os dispositivos.');
}

function renderProdutosAdmin(){
  const container = $('#prodList');
  container.innerHTML = '';
  
  if(state.products.length === 0){
    container.innerHTML = '<div class="empty">Nenhum produto cadastrado</div>';
    return;
  }
  
  state.products.forEach((prod, index) => {
    const produtoElement = document.createElement('div');
    produtoElement.className = 'order-card';
    produtoElement.style.marginBottom = '12px';
    produtoElement.innerHTML = `
      <div class="grid-2">
        <div class="field">
          <label>Nome</label>
          <input value="${prod.name || ''}" placeholder="Nome do produto" onchange="updateProductField(${index}, 'name', this.value)">
        </div>
        <div class="field">
          <label>Preço (R$)</label>
          <input value="${prod.price || 0}" type="number" step="0.01" min="0" onchange="updateProductField(${index}, 'price', this.value)">
        </div>
        <div class="field">
          <label>Descrição</label>
          <input value="${prod.desc || ''}" placeholder="Descrição" onchange="updateProductField(${index}, 'desc', this.value)">
        </div>
        <div class="field">
          <label>Categoria</label>
          <select onchange="updateProductField(${index}, 'cat', this.value)">
            <option value="Pizzas" ${prod.cat === 'Pizzas' ? 'selected' : ''}>Pizzas</option>
            <option value="Hambúrgueres" ${prod.cat === 'Hambúrgueres' ? 'selected' : ''}>Hambúrgueres</option>
            <option value="Bebidas" ${prod.cat === 'Bebidas' ? 'selected' : ''}>Bebidas</option>
            <option value="Combos" ${prod.cat === 'Combos' ? 'selected' : ''}>Combos</option>
            <option value="Outros" ${!['Pizzas','Hambúrgueres','Bebidas','Combos'].includes(prod.cat) ? 'selected' : ''}>Outros</option>
          </select>
        </div>
        <div class="field">
          <label>Imagem (URL)</label>
          <input value="${prod.img || ''}" placeholder="URL da imagem" onchange="updateProductField(${index}, 'img', this.value)">
        </div>
        <div class="field">
          <label>Disponível</label>
          <select onchange="updateProductField(${index}, 'available', this.value === 'true')">
            <option value="true" ${prod.available ? 'selected' : ''}>Sim</option>
            <option value="false" ${!prod.available ? 'selected' : ''}>Não</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:12px; justify-content: flex-end;">
        <button class="btn" onclick="removerProduto(${index})" style="border-color:rgba(255,92,92,.5)">Remover</button>
      </div>
      <div class="hr"></div>
    `;
    
    container.appendChild(produtoElement);
  });
}

function updateProductField(index, field, value) {
  if (field === 'price') {
    state.products[index][field] = Number(value);
  } else if (field === 'available') {
    state.products[index][field] = value === 'true' || value === true;
  } else {
    state.products[index][field] = value;
  }
  persist(); // Isso salvará automaticamente no Firebase também
}

function removerProduto(index){
  if(confirm('Tem certeza que deseja remover este produto?')){
    state.products.splice(index, 1);
    persist();
    renderProdutosAdmin();
    render();
  }
}

function addProduct(){
  const novoProduto = {
    id: uid(),
    name: 'Novo Produto',
    desc: '',
    price: 0,
    cat: 'Pizzas',
    img: '',
    available: true
  };
  state.products.unshift(novoProduto);
  persist();
  renderProdutosAdmin();
  render();
}

// Inicialização
document.addEventListener('DOMContentLoaded', function(){
  // Carregar estado salvo
  const savedState = loadState();
  if(savedState){
    state = savedState;
  }
  
  // Aplicar tema e renderizar
  applyTheme();
  renderChips();
  render();
  
  // Inicializar Firebase para atualizações em tempo real
  initializeFirebase();
  
  // Event listeners para modais
  $('#loginBack').addEventListener('click', function(e){
    if(e.target === this) hideLogin();
  });
  
  $('#adminBack').addEventListener('click', function(e){
    if(e.target === this) closeAdmin();
  });
  
  // Fechar modais com ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      if ($('#loginBack').style.display === 'flex') hideLogin();
      if ($('#adminBack').style.display === 'flex') closeAdmin();
      if ($('#sheet').classList.contains('open')) closeCart();
    }
  });
});
